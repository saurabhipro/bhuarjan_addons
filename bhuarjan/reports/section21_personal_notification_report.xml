<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Section 21 Personal Notification Report -->
    <record id="action_report_section21_personal_notification" model="ir.actions.report">
        <field name="name">Section 21 Personal Notice / धारा 21 व्यक्तिगत सूचना</field>
        <field name="model">bhu.section21.personal.notice</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">bhuarjan.section21_personal_notification_report</field>
        <field name="report_file">bhuarjan.section21_personal_notification_report</field>
        <field name="paperformat_id" ref="bhuarjan.bhuarjan_sia_paper_format"/>
        <field name="print_report_name">'Section21_Personal_Notice_' + ((object and object.khasra_number) or (docs and docs[0] and docs[0].khasra_number) or 'All')</field>
    </record>

    <!-- Section 21 Personal Notification Report Template -->
    <template id="section21_personal_notification_report">
        <t t-call="web.html_container">
            <meta charset="utf-8"/>
            
            <!-- Get all personal notices from docs (transient records) -->
            <t t-set="all_personal_notices" t-value="docs if docs else (object and [object] or [])"/>
            
            <!-- Get notification from first personal notice (it always has notification_id) -->
            <t t-set="notification" t-value="all_personal_notices and all_personal_notices[0].notification_id or None"/>
            <!-- Fallback: try context if needed -->
            <t t-if="not notification">
                <t t-set="notification_id" t-value="request.env.context.get('section21_notification_id') or request.env.context.get('active_id')"/>
                <t t-if="notification_id">
                    <t t-set="notification" t-value="request.env['bhu.section21.notification'].sudo().browse(notification_id)"/>
                </t>
            </t>
            
            <!-- Always render via basic_layout to avoid empty PDFs -->
            <t t-call="web.basic_layout">
                <t t-if="not all_personal_notices or not notification">
                    <div style="padding: 20px; text-align: center; font-size: 18px; color: red;">
                        <p><strong>No personal notices found or notification missing.</strong></p>
                        <p>Please ensure surveys exist and personal notices were generated.</p>
                    </div>
                </t>
                <t t-if="all_personal_notices and notification">
                    <!-- Reload notification to ensure all fields are loaded (same as public template) -->
                    <t t-set="notification" t-value="request.env['bhu.section21.notification'].sudo().browse(notification.id)"/>
                    <t t-set="land_parcels" t-value="notification.land_parcel_ids or []"/>
                    
                    <!-- Render each personal notice - one per khasra -->
                    <t t-set="notice_index" t-value="0"/>
                    <t t-foreach="all_personal_notices" t-as="personal_notice">
                        <!-- Page break between notices (not before first) -->
                        <t t-if="notice_index > 0">
                            <div style="page-break-before: always;"></div>
                        </t>
                        <t t-set="notice_index" t-value="notice_index + 1"/>
                        
                        <!-- Get khasra and landowner from personal notice -->
                        <t t-set="khasra_number" t-value="personal_notice.khasra_number or ''"/>
                        <t t-set="landowner" t-value="personal_notice.landowner_id or None"/>
                        <t t-set="landowner_name" t-value="landowner and landowner.name or ''"/>
                        <t t-set="landowner_father" t-value="landowner and landowner.father_name or ''"/>
                        <t t-set="landowner_spouse" t-value="landowner and landowner.spouse_name or ''"/>
                        <t t-set="landowner_address" t-value="landowner and landowner.owner_address or ''"/>
                        
                        <!-- Render this personal notice -->
                        <div>
                        <style>
                            body, html, .container, .page {
                                font-size: 18px !important;
                                font-family: 'Noto Sans Devanagari', 'Mangal', 'Arial Unicode MS', 'DejaVu Sans', sans-serif !important;
                            }
                            .letter_space {
                                letter-spacing: 1px !important;
                            }
                            .schedule-table {
                                width: 100% !important;
                                border-collapse: collapse !important;
                                margin: 8px 0 !important;
                                border: 2px solid #000 !important;
                                font-size: 18px !important;
                            }
                            .schedule-table th, .schedule-table td {
                                border: 1px solid #000 !important;
                                padding: 6px !important;
                                text-align: center !important;
                                font-size: 18px !important;
                                vertical-align: middle !important;
                            }
                            .schedule-table th {
                                background-color: #f5f5f5 !important;
                                font-weight: bold !important;
                                font-size: 18px !important;
                                padding: 7px 8px !important;
                            }
                            .watermark {
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                opacity: 0.1;
                                z-index: 0;
                                pointer-events: none;
                                width: 600px;
                                height: 600px;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                            }
                            .watermark img {
                                width: 500px;
                                height: 500px;
                                object-fit: contain;
                            }
                            .watermark-circle {
                                position: absolute;
                                width: 550px;
                                height: 550px;
                                border: 2px solid rgba(0, 0, 0, 0.1);
                                border-radius: 50%;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                z-index: -1;
                            }
                            .container {
                                position: relative;
                                z-index: 1;
                                background: transparent;
                                box-sizing: border-box;
                            }
                            body, html {
                                height: 100%;
                                margin: 0;
                                padding: 0;
                            }
                            @page {
                                size: A4;
                                margin: 0;
                            }
                        </style>
                        
                        <div class="container letter_space" style="border: 2px dotted #000; padding: 15px; margin: 10px; position: relative; min-height: calc(100vh - 20px);">
                            <!-- Watermark -->
                            <t t-set="base_url" t-value="request.env['ir.config_parameter'].sudo().get_param('web.base.url') or ''"/>
                            <div class="watermark">
                                <div class="watermark-circle"></div>
                                <t t-if="base_url">
                                    <img t-att-src="base_url + '/bhuarjan/static/description/logo.png'" alt="Logo" style="max-width: 100%; height: auto;"/>
                                </t>
                            </div>
                            
                            <!-- Header -->
                            <div style="text-align: center; margin-bottom: 8px;">
                                <h2 style="margin: 0; padding: 0; font-size: 22px; font-weight: bold;">
                                    <strong>न्यायालय कलेक्टर, जिला-<span t-esc="notification.district_id.name if notification.district_id else 'रायगढ़'"/> (छ.ग.)</strong>
                                </h2>
                            </div>
                            
                            <!-- Notice Title -->
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; padding: 0; font-size: 20px; font-weight: bold;">
                                    <strong>धारा 21 (1) के अधीन सूचना</strong>
                                </h3>
                            </div>
                            
                            <!-- Notice Content -->
                            <div style="margin-bottom: 12px; font-size: 18px; line-height: 1.6;">
                                <p style="margin: 5px 0; text-align: justify;">
                                    <strong>प्रिय</strong> <t t-esc="landowner_name or 'श्री/श्रीमती ........................'"/>,
                                </p>
                                <p style="margin: 5px 0; text-align: justify;">
                                    पिता/पति: <t t-esc="landowner_father or landowner_spouse or '........................'"/>,
                                </p>
                                <p style="margin: 5px 0; text-align: justify;">
                                    पता: <t t-esc="landowner_address or '........................'"/>
                                </p>
                                <p style="margin: 10px 0; text-align: justify;">
                                    <strong>विषय:</strong> भूमि अधिग्रहण अधिनियम, 2013 की धारा 21 (1) के अधीन सूचना।
                                </p>
                                <p style="margin: 5px 0; text-align: justify;">
                                    आपको सूचित किया जाता है कि <t t-esc="notification.project_id.department_id.name if (notification.project_id and notification.project_id.department_id) else '........................'"/> द्वारा <t t-esc="notification.project_id.name if notification.project_id else '........................'"/> के लिए आपकी भूमि का अधिग्रहण किया जा रहा है।
                                </p>
                                <p style="margin: 5px 0; text-align: justify;">
                                    दिनांक <t t-esc="notification.notice_date.strftime('%d/%m/%Y') if notification.notice_date else '........................'"/> को जारी की गई सूचना के अनुसार, निम्नलिखित भूमि का अधिग्रहण किया जा रहा है:
                                </p>
                            </div>
                            
                            <!-- Land Parcels Table - Filter by khasra_number -->
                            <table style="width: 100%; border-collapse: collapse; margin: 12px 0; border: 2px solid #000; font-size: 18px; text-align: center;">
                                <thead>
                                    <tr>
                                        <th style="width: 25%; border: 1px solid #000; padding: 6px; background: #f5f5f5; font-weight: bold;">खसरा क्रमांक</th>
                                        <th style="width: 25%; border: 1px solid #000; padding: 6px; background: #f5f5f5; font-weight: bold;">अर्जित रकबा</th>
                                        <th style="width: 25%; border: 1px solid #000; padding: 6px; background: #f5f5f5; font-weight: bold;">रिमार्क</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="row_num" t-value="0"/>
                                    <t t-set="parcel_found" t-value="False"/>
                                    <t t-foreach="land_parcels" t-as="parcel">
                                        <t t-set="parcel_khasra" t-value="str(parcel.khasra_number) if parcel.khasra_number else ''"/>
                                        <t t-set="target_khasra" t-value="str(khasra_number) if khasra_number else ''"/>
                                        <t t-if="parcel_khasra == target_khasra">
                                            <t t-set="parcel_found" t-value="True"/>
                                            <t t-set="row_num" t-value="row_num + 1"/>
                                            <tr>
                                                <td style="border: 1px solid #000; padding: 6px;"><t t-esc="parcel.khasra_number or '........................'"/></td>
                                                <t t-set="area_str" t-value="'{:.3f}'.format(parcel.area_hectares) if parcel.area_hectares else '........................'"/>
                                                <td style="border: 1px solid #000; padding: 6px;"><t t-esc="area_str"/></td>
                                                <td style="border: 1px solid #000; padding: 6px;"><t t-esc="parcel.remark or ''"/></td>
                                            </tr>
                                        </t>
                                    </t>
                                    <t t-if="not parcel_found">
                                        <tr>
                                            <td style="border: 1px solid #000; padding: 6px;"><t t-esc="khasra_number or '........................'"/></td>
                                            <td style="border: 1px solid #000; padding: 6px;">........................</td>
                                            <td style="border: 1px solid #000; padding: 6px;"></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                            
                            <!-- Additional Information -->
                            <div style="margin-top: 12px; font-size: 18px; line-height: 1.6;">
                                <p style="margin: 5px 0; text-align: justify;">
                                    जिला: <t t-esc="notification.district_id.name if notification.district_id else 'रायगढ़'"/> | 
                                    तहसील: <t t-esc="notification.tehsil_id.name if notification.tehsil_id else '........................'"/> | 
                                    ग्राम: <t t-esc="notification.village_id.name if notification.village_id else '........................'"/>
                                </p>
                                <p style="margin: 5px 0; text-align: justify;">
                                    परियोजना: <t t-esc="notification.project_id.name if notification.project_id else '........................'"/>
                                </p>
                            </div>
                            
                            <!-- Signatures -->
                            <div style="margin-top: 20px;">
                                <div style="text-align: left; margin-top: 15px;">
                                    <div style="margin: 5px 0; font-size: 18px;">
                                        <span t-esc="notification.collector_name if notification.collector_name else 'कलेक्टर'"/>
                                    </div>
                                    <div style="margin: 3px 0; font-size: 18px;">
                                        जिला-<t t-esc="notification.district_id.name if notification.district_id else 'रायगढ़'"/>
                                    </div>
                                </div>
                                <div style="text-align: right; margin-top: 15px;">
                                    <div style="margin: 5px 0; font-size: 18px;">
                                        <span t-esc="notification.additional_collector_name if notification.additional_collector_name else 'अपर कलेक्टर'"/>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Copy Recipients -->
                            <div style="margin-top: 25px; border-top: 1px solid #000; padding-top: 10px;">
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">
                                    <strong>प्रतिलिपि:</strong>
                                </div>
                                <div style="font-size: 18px; line-height: 1.8;">
                                    <p style="margin: 3px 0;">1. <t t-if="landowner and landowner.name"><t t-esc="landowner.name"/></t><t t-if="not landowner or not landowner.name">श्री/श्रीमती ........................</t></p>
                                    <p style="margin: 3px 0;">2. दिनांक: <t t-esc="notification.notice_date.strftime('%d/%m/%Y') if notification.notice_date else '........................'"/></p>
                                </div>
                            </div>
                        </div>
                        </div>
                    </t>
                </t>
            </t>
        </t>
    </template>
</odoo>
