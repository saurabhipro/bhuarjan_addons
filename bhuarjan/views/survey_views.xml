<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Survey List View -->
    <record id="view_bhu_survey_list" model="ir.ui.view">
        <field name="name">bhu.survey.list</field>
        <field name="model">bhu.survey</field>
        <field name="arch" type="xml">
            <list string="Surveys / सर्वे" decoration-info="state == 'draft'" decoration-success="state == 'approved'" decoration-danger="state == 'rejected'" decoration-muted="state == 'locked'" multi_edit="1">
                <field name="name"/>
                <field name="user_id"/>
                <field name="project_id"/>
                <field name="village_id"/>
                <field name="tehsil_id"/>
                <field name="khasra_number"/>
                <field name="total_area"/>
                <field name="acquired_area"/>
                <field name="survey_date"/>
                <field name="state" widget="badge"/>
                
            </list>
        </field>
    </record>

    <!-- Survey Form View -->
    <record id="view_bhu_survey_form" model="ir.ui.view">
        <field name="name">bhu.survey.form</field>
        <field name="model">bhu.survey</field>
        <field name="arch" type="xml">
            <form string="Survey / सर्वे">
                <header>
                    <button name="action_submit" string="Submit / प्रस्तुत करें" type="object" class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_approve" string="Approve / अनुमोदित करें" type="object" class="btn-success" invisible="state != 'submitted'"/>
                    <button name="action_reject" string="Reject / अस्वीकृत करें" type="object" class="btn-danger" invisible="state != 'submitted'"/>
                    <button name="action_reset_to_draft" string="Reset to Draft / प्रारूप में रीसेट" type="object" invisible="state != 'rejected'"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,submitted,approved,locked"/>
                </header>
                <sheet>
                    <div class="oe_title" style="margin-bottom: 10px;">
                        <h1 style="margin-bottom: 5px;">
                            <field name="name" placeholder="Survey Number / सर्वे नंबर" required="1"/>
                        </h1>
                    </div>
                    
                    <!-- Locked Survey Warning -->
                    <div class="alert alert-warning" role="alert" invisible="state != 'locked'" style="margin-bottom: 15px;">
                        <strong>Survey Locked / सर्वे लॉक:</strong> This survey has been used to generate Notification 4 and is now locked. No further modifications are allowed.
                        <br/>
                        <strong>सर्वे लॉक:</strong> इस सर्वे का उपयोग अधिसूचना 4 जेनरेट करने के लिए किया गया है और अब यह लॉक है। कोई और संशोधन की अनुमति नहीं है।
                    </div>
                    
                    <group>
                        <group string="Project Information / परियोजना की जानकारी">
                            <field name="project_id" widget="selection" readonly="state == 'locked'" required="1" string="Project * / परियोजना *"/>
                            <field name="department_id" widget="selection" readonly="state == 'locked'" required="1" string="Department * / विभाग *"/>
                            <field name="survey_date" widget="date" readonly="state == 'locked'" required="1" string="Survey Date * / सर्वे दिनाँक *" options="{'date_format': 'dd/mm/yyyy'}"/>
                        </group>
                        <group string="Location Information / स्थान की जानकारी">
                            <field name="company_id" readonly="state == 'locked'" required="1" string="Company * / कंपनी *"/>
                            <field name="village_id" widget="selection" readonly="state == 'locked'" required="1" string="Village * / ग्राम का नाम *"/>
                            <field name="tehsil_id" widget="selection" readonly="state == 'locked'" required="1" string="Tehsil * / तहसील *"/>
                            <field name="district_name" readonly="state == 'locked'"/>
                            <field name="user_id"/>
                        </group>
                    </group>
                    
                    <group string="Landowners / भूमिस्वामी" style="margin-top: 10px;">
                        <field name="landowner_ids" widget="many2many_tags" options="{'no_create': False, 'no_create_edit': False}"/>
                    </group>
                    
                    <field name="survey_uuid" readonly="1" invisible="1"/>
                    
                    <notebook>
                        <page string="Survey / सर्वे" name="survey_details">
                            <group>
                                <group string="Land Information / भूमि की जानकारी">
                                    <field name="khasra_number" widget="char" readonly="state == 'locked'" required="1" string="Khasra Number * / खसरा नंबर *"/>
                                    <field name="total_area" widget="float" readonly="state == 'locked'"/>
                                    <field name="acquired_area" widget="float" readonly="state == 'locked'"/>
                                </group>
                                <group string="Crop Information / फसल की जानकारी">
                                    <field name="crop_type" widget="radio" readonly="state == 'locked'" options="{'horizontal': true}"/>
                                    <field name="irrigation_type" widget="radio" readonly="state == 'locked'" options="{'horizontal': true}"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Tree Information / वृक्ष की जानकारी">
                                    <field name="tree_development_stage" widget="selection" readonly="state == 'locked'"/>
                                    <field name="tree_count" widget="integer" readonly="state == 'locked'"/>
                                    <field name="trees_description" widget="text" readonly="state == 'locked'" 
                                           placeholder="Enter detailed description of trees present on the land"/>
                                </group>
                                <group string="House Information / घर की जानकारी">
                                    <field name="house_type" widget="selection" readonly="state == 'locked'"/>
                                    <field name="house_area" widget="float" readonly="state == 'locked'"/>
                                    <field name="shed_area" widget="float" readonly="state == 'locked'"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Infrastructure / बुनियादी सुविधाएं">
                                    <field name="has_well" widget="radio" readonly="state == 'locked'" options="{'horizontal': true}"/>
                                    <field name="well_type" widget="selection" invisible="has_well != 'yes'" readonly="state == 'locked'"/>
                                    <field name="has_tubewell" widget="radio" readonly="state == 'locked'" options="{'horizontal': true}"/>
                                    <field name="has_pond" widget="radio" readonly="state == 'locked'" options="{'horizontal': true}"/>
                                </group>
                                <group string="Survey Image / सर्वे छवि">
                                    <field name="survey_image" widget="image" class="oe_avatar"/>
                                    <field name="survey_image_filename" invisible="1"/>
                                </group>
                            </group>
                            
                            <group>
                                <group string="Attachments / संलग्नक">
                                    <field name="attachment_ids" widget="many2many_binary"/>
                                </group>
                            </group>
                            
                        </page>
                        
                        <page string="Landowner / भूमिस्वामी" name="landowners_details">
                            <field name="landowner_ids" readonly="1">
                                <list string="Landowner Details / भूमिस्वामी विवरण">
                                    <field name="name" string="Name / नाम"/>
                                    <field name="father_name" string="Father's Name / पिता का नाम"/>
                                    <field name="age" string="Age / आयु"/>
                                    <field name="gender" string="Gender / लिंग"/>
                                    <field name="mobile" string="Mobile / मोबाइल"/>
                                    <field name="email" string="Email / ईमेल"/>
                                    <field name="village_id" string="Village / ग्राम"/>
                                    <field name="tehsil_id" string="Tehsil / तहसील"/>
                                    <field name="district_id" string="District / जिला"/>
                                    <field name="aadhar_number" string="Aadhar / आधार"/>
                                    <field name="pan_number" string="PAN / पैन"/>
                                    <field name="bank_name" string="Bank / बैंक"/>
                                    <field name="account_number" string="Account / खाता"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                    
                    <!-- Chatter removed -->
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Survey Search View -->
    <record id="view_bhu_survey_search" model="ir.ui.view">
        <field name="name">bhu.survey.search</field>
        <field name="model">bhu.survey</field>
        <field name="arch" type="xml">
            <search string="Search Surveys / सर्वे खोजें">
                <field name="name"/>
                <field name="landowner_ids"/>
                <field name="project_id"/>
                <field name="department_id"/>
                <field name="village_id"/>
                <field name="tehsil_id"/>
                <field name="khasra_number"/>
                <field name="survey_date"/>
                <field name="survey_uuid"/>
                
                <field name="landowner_pan_numbers" string="Pan Number"/>
                <field name="landowner_aadhar_numbers" string="Aadhar Number"/>
            
                <filter string="Draft / प्रारूप" name="draft" domain="[('state', '=', 'draft')]"/>

                <filter string="Submitted / प्रस्तुत" name="submitted" domain="[('state', '=', 'submitted')]"/>
                <filter string="Approved / अनुमोदित" name="approved" domain="[('state', '=', 'approved')]"/>
                <filter string="Rejected / अस्वीकृत" name="rejected" domain="[('state', '=', 'rejected')]"/>
                
                <separator/>
                <filter string="This Month / इस महीने" name="this_month" domain="[('survey_date', '>=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-01')), ('survey_date', '&lt;', (context_today() + relativedelta(months=1)).strftime('%Y-%m-01'))]"/>
                <filter string="This Year / इस साल" name="this_year" domain="[('survey_date', '>=', context_today().strftime('%Y-01-01')), ('survey_date', '&lt;', (context_today() + relativedelta(years=1)).strftime('%Y-01-01'))]"/>
                
                <group expand="0" string="Group By / समूह बनाएं">
                    <filter string="State / स्थिति" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Village / ग्राम" name="group_village" context="{'group_by': 'village_id'}"/>
                    <filter string="Tehsil / तहसील" name="group_tehsil" context="{'group_by': 'tehsil_id'}"/>
                    <filter string="Khasra Number / खसरा नंबर" name="group_khasra" context="{'group_by': 'khasra_number'}"/>
                    <filter string="Project / परियोजना" name="group_project" context="{'group_by': 'project_id'}"/>
                    <filter string="Department / विभाग" name="group_department" context="{'group_by': 'department_id'}"/>
                    <filter string="Survey Date / सर्वे दिनाँक" name="group_survey_date" context="{'group_by': 'survey_date'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Survey Action -->
    <record id="action_bhu_survey" model="ir.actions.act_window">
        <field name="name">Surveys / सर्वे</field>
        <field name="res_model">bhu.survey</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="search_view_id" ref="view_bhu_survey_search"/>
        <field name="context">{'search_default_this_year': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Survey!
            </p>
            <p>
                Survey is used for preliminary land acquisition surveys.
                You can add multiple citizens/landowners in one survey.
            </p>
        </field>
    </record>

    <!-- Bulk Download Form-10 Action -->
    <record id="action_bulk_download_form10" model="ir.actions.server">
        <field name="name">Download Form-10 PDFs jhgjhg / फार्म-10 PDF डाउनलोड करें</field>
        <field name="model_id" ref="model_bhu_survey"/>
        <field name="binding_model_id" ref="model_bhu_survey"/>
        <field name="state">code</field>
        <field name="code">
        <!-- if records: -->
            <!-- action = records.action_bulk_download_form10() -->
                action = model.action_bulk_download_form10()

        </field>
    </record>


    <!-- Form 10 Preview Action -->
    <record id="action_form10_preview" model="ir.actions.server">
        <field name="name">Form 10 Preview / फार्म-10 पूर्वावलोकन</field>
        <field name="model_id" ref="model_bhu_survey"/>
        <field name="binding_model_id" ref="model_bhu_survey"/>
        <field name="binding_view_types">list,form</field>
        <field name="state">code</field>
        <field name="code">
# Get all surveys visible in the current list view (respects filters and search)
surveys = env['bhu.survey'].search([])
if surveys:
    action = surveys.action_form10_preview()
</field>
    </record>

    <!-- Survey Kanban View -->
    <record id="view_bhu_survey_kanban" model="ir.ui.view">
        <field name="name">bhu.survey.kanban</field>
        <field name="model">bhu.survey</field>
        <field name="arch" type="xml">
        <kanban string="Surveys / सर्वे" class="o_kanban_large_column o_kanban_mobile">
                <field name="name"/>
                <field name="project_id"/>
                <field name="village_id"/>
                <field name="state"/>
                <field name="survey_date"/>
                <field name="user_id"/>
                <field name="user_id" widget="image"/>
                <field name="khasra_number"/>

                <templates>
                    <t t-name="kanban-box">
                    <div class="oe_kanban_card o_kanban_record" style="background: #ffffff; border: 2px solid #d1d5db; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                        <div class="oe_kanban_content p-3">
                            
                            <!-- Compact Header -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    
                                    <h5 class="mb-1 text-dark font-weight-bold" style="font-size: 1rem; font-weight: 700;">
                                        <field name="name"/>
                                    </h5>
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fa fa-folder mr-1 text-muted" style="font-size: 0.8rem;" title="Project"></i>
                                        <span class="text-muted small">
                                            <field name="project_id"/>
                                        </span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-map-marker mr-1 text-muted" style="font-size: 0.8rem;" title="Khasra"></i>
                                        <span class="text-muted small">
                                            Khasra: <field name="khasra_number"/>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- User Image/Avatar -->
                                <div class="d-flex flex-column align-items-center">
                                    
                                        <field name="user_id" widget="many2one_avatar_user"/>
                                </div>
                                
                                <!-- Actions Dropdown -->
                                <div class="dropdown ml-1">
                                    <a class="dropdown-toggle text-muted" data-toggle="dropdown" href="#" title="Actions" style="font-size: 0.9rem;">
                                        <i class="fa fa-ellipsis-v" title="More Actions"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right" role="menu" style="border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                        <a role="menuitem" type="edit" class="dropdown-item">
                                            <i class="fa fa-pencil-alt mr-2 text-primary" title="Edit"></i> Edit
                                        </a>
                                        <a role="menuitem" class="dropdown-item" onclick="shareOnWhatsApp()">
                                            <i class="fab fa-whatsapp mr-2 text-success" title="Share on WhatsApp"></i> Share on WhatsApp
                                        </a>
                                        <a role="menuitem" type="delete" class="dropdown-item text-danger">
                                            <i class="fa fa-trash mr-2" title="Delete"></i> Delete
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Compact Body -->
                            <div class="mb-2">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fa fa-home mr-3 text-muted" style="font-size: 0.8rem;" title="Village"></i>
                                    <span class="text-muted small mr-3">Village:</span>
                                    <span class="text-dark small">
                                        <field name="village_id"/>
                                    </span>
                                </div>
                                
                                <div class="d-flex align-items-center mb-1">
                                    <i class="fa fa-calendar mr-3 text-muted" style="font-size: 0.8rem;" title="Date"></i>
                                    <span class="text-muted small mr-3">Date:</span>
                                    <span class="text-dark small">
                                        <field name="survey_date"/>
                                    </span>
                                </div>
                            </div>

                            <!-- Compact Footer -->
                            <div class="d-flex justify-content-between align-items-center border-top pt-2" style="border-color: #f3f4f6 !important;">
                                <span t-attf-class="badge px-3 py-2 text-uppercase small font-weight-bold" 
                                      t-attf-style="#{record.state.raw_value == 'approved' and 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #ffffff; border: 2px solid #047857; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);' 
                                      or record.state.raw_value == 'locked' and 'background: #6b7280; color: #ffffff; border: 1px solid #4b5563; box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);' 
                                      or record.state.raw_value == 'submitted' and 'background: #fef3c7; color: #92400e; border: 1px solid #fde68a;' 
                                      or record.state.raw_value == 'draft' and 'background: #fbbf24; color: #92400e; border: 1px solid #f59e0b; box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);' 
                                      or 'background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;'">
                                    <i t-if="record.state.raw_value == 'locked'" class="fa fa-lock mr-1" style="font-size: 0.8rem;" title="Locked"></i>
                                    <field name="state"/>
                                </span>
                                <div class="d-flex align-items-center text-muted">
                                    <i class="fa fa-camera mr-1" style="font-size: 0.8rem;" title="Survey"></i>
                                    <span class="small">Survey</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- WhatsApp Share JavaScript -->
    <template id="whatsapp_share_script" name="WhatsApp Share Script">
        <script type="text/javascript">
            function shareOnWhatsApp() {
                // Get current survey data
                var surveyName = document.querySelector('.oe_kanban_card h5').textContent;
                var projectName = document.querySelector('.oe_kanban_card .fa-folder').nextSibling.textContent.trim();
                var villageName = document.querySelector('.oe_kanban_card .fa-home').parentElement.querySelector('div').textContent.trim();
                var surveyDate = document.querySelector('.oe_kanban_card .fa-calendar').parentElement.querySelector('div').textContent.trim();
                
                // Create survey URL
                var surveyUrl = window.location.origin + '/web#model=bhu.survey&amp;view_type=form';
                
                // Create WhatsApp message
                var message = '🏗️ *Survey Update*\n\n' +
                             '📋 *Survey:* ' + surveyName + '\n' +
                             '🏢 *Project:* ' + projectName + '\n' +
                             '🏘️ *Village:* ' + villageName + '\n' +
                             '📅 *Date:* ' + surveyDate + '\n\n' +
                             '🔗 *View Details:* ' + surveyUrl;
                
                // Encode message for URL
                var encodedMessage = encodeURIComponent(message);
                
                // Open WhatsApp
                var whatsappUrl = 'https://wa.me/?text=' + encodedMessage;
                window.open(whatsappUrl, '_blank');
            }
        </script>
    </template>


    <!-- Custom Mail Message View to Hide Related Document Fields -->

</odoo>
